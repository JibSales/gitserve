#! /usr/bin/env node

// -- Load modules
var http = require('http')
  , optimist = require('optimist')
  , colors = require('colors')
  , express = require('express')
  , utils = require('../lib/utils')
  , pkg = require('../package');

// -- Define argv properties
var argv = optimist
  .usage(utils.usage.join('\n'))
  .options('p', {
    alias: 'port',
    describe: 'Port to start the server on.'.grey,
    default: '3000'
  })
  .options('r', {
    alias: 'repos',
    describe: 'Directory where the repos to serve are located.'.grey,
    default: './'
  })
  .options('h', {
    alias: 'help',
    describe: 'You\'re looking at it.'.grey
  })
  .options('v', {
    alias: 'version',
    describe: 'Print the version number.'.grey
  })
  .argv

// -- Print version number
if (argv.v) {
  console.log(pkg.name + ' v' + pkg.version);
  process.exit(0);
}

// -- Show help screen
if (argv.help || argv._.length === 0) {
  optimist.showHelp();
  process.exit(0);
}

// -- Start simple HTTP server
if ('start' === argv._[0]) {
  var app = express();
  
  if ("development" === app.get('env')) {
    app.use(express.logger('dev'));  
  }

  app.set('repos', argv.repos)

  app.use(require('../lib/gitserve').middleware);
  app.use(app.router);
  app.use(express.static(__dirname + '/../public'));

  http.createServer(app).listen(argv.port, function () {
    utils.printBootscreen(argv);
  });
}